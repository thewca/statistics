queries:
  - keys:
      - Competitors
    showPositions: true
    positionTieBreakerIndex: 1
    headers:
      - Competitor
      - Events
    sqlQuery: |-
      select
          personId,
          personName,
          worldRecordEvents
      from
          (
              select
                  personId,
                  personName,
                  count(distinct eventId) worldRecordEvents
              from
                  Results r
                  inner join Events e on r.eventId = e.id
              where
                  (
                      regionalSingleRecord = 'WR'
                      or regionalAverageRecord = 'WR'
                  )
                  and e.`rank` < 900
              group by
                  personId,
                  personName
              order by
                  worldRecordEvents DESC,
                  personName
          ) worldRecordEvents
      where
          worldRecordEvents >= (
              select
                  min(worldRecordEvents)
              from
                  (
                      select
                          count(distinct eventId) worldRecordEvents
                      from
                          Results r
                          inner join Events e on r.eventId = e.id
                      where
                          (
                              regionalSingleRecord = 'WR'
                              or regionalAverageRecord = 'WR'
                          )
                          and e.`rank` < 900
                      group by
                          personId,
                          personName
                      order by
                          worldRecordEvents DESC,
                          personName
                      limit
                          10
                  ) min_records
          )
    sqlQueryCustom: |-
      select
      	id,
      	name,
      	(
      	select
      		count(distinct eventId)
      	from
      		Results r
      	inner join Events e on
      		r.eventId = e.id
      	where
      		r.personId = p.id
      		and e.`rank` < 900
      		-- Active events
      		and (regionalAverageRecord = 'WR'
      		or regionalSingleRecord = 'WR')) events
      from
      	Persons p
      where
      	p.id = ':WCA_ID'
title: World records in most events
